{% extends "base.html" %}

{% block title %}Результат анализа - General Movements Assessment{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/analysis.css') }}">
<style>
.result-detail-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 24px;
}

.result-header {
    background: white;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.result-header h1 {
    margin-bottom: 16px;
    color: #2c3e50;
}

.patient-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 16px;
    margin-bottom: 16px;
}

.info-item {
    padding: 12px;
    background: #f8f9fa;
    border-radius: 8px;
}

.info-item label {
    display: block;
    font-size: 0.85rem;
    color: #7f8c8d;
    margin-bottom: 4px;
}

.info-item span {
    font-size: 1rem;
    color: #2c3e50;
    font-weight: 500;
}

.result-content {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 24px;
}

.report-text {
    white-space: pre-wrap;
    line-height: 1.8;
    color: #2c3e50;
    font-size: 1rem;
}

.result-media {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 24px;
    margin-bottom: 24px;
}

.media-item {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.media-item h3 {
    margin-bottom: 16px;
    color: #2c3e50;
}

.media-item video,
.media-item img {
    width: 100%;
    border-radius: 8px;
}

.result-actions {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.anomaly-badge {
    display: inline-block;
    padding: 6px 16px;
    border-radius: 16px;
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 16px;
}

.anomaly-badge.detected {
    background: #fee;
    color: #c33;
}

.anomaly-badge.normal {
    background: #efe;
    color: #3c3;
}
</style>
{% endblock %}

{% block content %}
<div class="result-detail-container">
    <div class="result-header">
        <h1>Результат анализа</h1>
        <span class="anomaly-badge {% if result.is_anomaly %}detected{% else %}normal{% endif %}">
            {% if result.is_anomaly %}Обнаружена аномалия{% else %}Норма{% endif %}
        </span>
        
        <div class="patient-info">
            <div class="info-item">
                <label>Пациент</label>
                <span>
                    {{ result.patient_last_name }} {{ result.patient_first_name }}
                    {% if result.patient_middle_name %}{{ result.patient_middle_name }}{% endif %}
                </span>
            </div>
            <div class="info-item">
                <label>Дата рождения</label>
                <span>{{ result.patient_birth_date }}</span>
            </div>
            {% if result.age_weeks %}
            <div class="info-item">
                <label>Возраст на момент анализа</label>
                <span>{{ result.age_weeks }} недель</span>
            </div>
            {% endif %}
            {% if result.gestational_age %}
            <div class="info-item">
                <label>Гестационный возраст</label>
                <span>{{ result.gestational_age }} недель</span>
            </div>
            {% endif %}
            <div class="info-item">
                <label>Дата анализа</label>
                <span>{{ result.created_at }}</span>
            </div>
            {% if result.video_filename %}
            <div class="info-item">
                <label>Видео файл</label>
                <span>{{ result.video_filename }}</span>
            </div>
            {% endif %}
        </div>
    </div>
    
    {% if result.report_text %}
    <div class="result-content">
        <h2>Медицинский отчет</h2>
        <div class="report-text">{{ result.report_text }}</div>
    </div>
    {% endif %}
    
    {% if result.output_dir %}
    <div class="result-media">
        <div class="media-item">
            <h3>Видео с наложенным скелетом</h3>
            <video controls preload="metadata" style="width: 100%; max-width: 100%;">
                <source src="/results/{{ result.output_dir }}/video_with_skeleton.mp4" type="video/mp4">
                Ваш браузер не поддерживает видео тег. <a href="/results/{{ result.output_dir }}/video_with_skeleton.mp4" download>Скачайте видео</a>
            </video>
        </div>
        
        <div class="media-item">
            <h3>График ошибки реконструкции</h3>
            <img src="/results/{{ result.output_dir }}/reconstruction_error.png" alt="График ошибки реконструкции">
        </div>
    </div>
    {% endif %}
    
    <div class="result-actions">
        {% if result.output_dir %}
        <a href="/api/download_results?dir={{ result.output_dir }}" class="btn-primary btn-large">
            Скачать результаты
        </a>
        {% endif %}
        <a href="{{ url_for('history') }}" class="btn-secondary btn-large">
            Вернуться к истории
        </a>
    </div>
</div>
{% endblock %}

# Админ-панель - Документация

## Обзор

Админ-панель предоставляет полный контроль над системой для администраторов. Доступна только пользователям с ролью `admin`.

## Безопасность

### Хэширование паролей
- Используется **bcrypt** с 12 раундами для безопасного хэширования паролей
- Bcrypt автоматически добавляет соль к каждому паролю
- Старые пароли (SHA-256) будут работать до следующей смены пароля

### Защита от SQL инъекций
- Все запросы к базе данных используют **параметризованные запросы**
- Пользовательский ввод никогда не вставляется напрямую в SQL
- Пример: `cursor.execute("SELECT * FROM users WHERE id = ?", (user_id,))`

## Доступ к админке

### Создание администратора

```bash
python create_admin.py
```

**Учетные данные по умолчанию:**
- Email: `admin@admin.com`
- Username: `admin`
- Password: `admin123`

⚠️ **ВАЖНО**: Измените пароль после первого входа!

### Вход в админку

1. Войдите в систему с учетными данными администратора
2. В header появится кнопка "Админ-панель"
3. Или перейдите напрямую: `http://127.0.0.1:5000/admin`

## Функции админки

### 1. Управление пользователями (`/admin/users`)

**Возможности:**
- Просмотр всех пользователей системы
- Редактирование данных пользователей:
  - Имя пользователя
  - Email
  - Полное имя
  - Роль (user/admin)
  - Статус активности
  - Смена пароля
- Удаление пользователей

**Безопасность:**
- Все операции логируются в `logs/admin.log`
- Используются параметризованные запросы
- Проверка уникальности email и username

### 2. Журнал логов (`/admin/logs`)

**Типы логов:**
- **Все логи** (`/admin/logs?type=all`) - все записи системы
- **Приложение** (`/admin/logs?type=app`) - логи приложения (`logs/app.log`)
- **Ошибки** (`/admin/logs?type=errors`) - только ошибки (`logs/errors.log`)
- **Админка** (`/admin/logs?type=admin`) - действия администраторов (`logs/admin.log`)

**Формат логов:**
```
2024-12-17 10:30:45 - logger_name - LEVEL - message
```

**Ротация логов:**
- Максимальный размер файла: 10 MB
- Количество резервных копий: 5-10 файлов
- Автоматическая ротация при достижении лимита

## Структура файлов

```
├── auth/
│   ├── database.py          # База данных с bcrypt и защитой от SQL инъекций
│   └── auth_manager.py      # Менеджер аутентификации
├── utils/
│   └── logger_config.py    # Конфигурация логирования
├── templates/
│   └── admin/
│       ├── dashboard.html   # Главная страница админки
│       ├── users.html       # Список пользователей
│       ├── edit_user.html   # Редактирование пользователя
│       └── logs.html        # Просмотр логов
├── static/
│   └── css/
│       └── admin.css        # Стили админки
├── logs/                    # Директория логов
│   ├── app.log             # Основные логи
│   ├── errors.log          # Ошибки
│   └── admin.log           # Логи админки
└── create_admin.py         # Скрипт создания администратора
```

## API Endpoints

### Админ-панель
- `GET /admin` - Главная страница админки
- `GET /admin/users` - Список пользователей
- `GET /admin/users/<id>/edit` - Форма редактирования пользователя
- `POST /admin/users/<id>/edit` - Обновление пользователя
- `POST /admin/users/<id>/delete` - Удаление пользователя
- `GET /admin/logs` - Просмотр логов

Все маршруты защищены декоратором `@require_admin()`.

## Логирование действий администратора

Все действия администратора логируются в `logs/admin.log`:

- Вход администратора в систему
- Просмотр списка пользователей
- Редактирование пользователей
- Удаление пользователей
- Просмотр логов

## Миграция старых паролей

Если в системе есть пользователи со старыми паролями (SHA-256), они будут работать до следующей смены пароля. При смене пароля через админку будет использоваться bcrypt.

## Рекомендации по безопасности

1. **Измените пароль администратора** после первого входа
2. **Используйте сложные пароли** (минимум 12 символов, буквы, цифры, символы)
3. **Регулярно проверяйте логи** на подозрительную активность
4. **Деактивируйте неиспользуемые аккаунты** вместо удаления
5. **Ограничьте количество администраторов** в системе
6. **Используйте HTTPS** в продакшене
7. **Регулярно обновляйте зависимости** (особенно bcrypt и Flask)

## Примеры использования

### Просмотр всех пользователей
```python
from auth.database import UserDatabase
db = UserDatabase()
users = db.get_all_users()
```

### Обновление пользователя
```python
success, message = db.update_user(
    user_id=1,
    username="new_username",
    email="new@email.com",
    role="admin",
    is_active=True,
    password="new_password"
)
```

### Удаление пользователя
```python
success, message = db.delete_user(user_id=1)
```

## Устранение проблем

### Проблема: "Требуется роль: admin"
**Решение**: Убедитесь, что пользователь имеет роль `admin` в базе данных.

### Проблема: Логи не отображаются
**Решение**: Проверьте, что директория `logs/` существует и файлы логов созданы.

### Проблема: Ошибка при создании администратора
**Решение**: Убедитесь, что bcrypt установлен: `pip install bcrypt`

# –£–ª—É—á—à–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–ª—é—á–µ–≤—ã—Ö —Ç–æ—á–µ–∫

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü–†–û–ë–õ–ï–ú–ê 1: –û–±—Ä–∞–±–æ—Ç–∫–∞ None-landmarks ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

**–ë—ã–ª–æ:**
```python
def _landmarks_to_list(self, pose_landmarks) -> Optional[List[Dict[str, float]]]:
    if pose_landmarks is None:
        return None  # ‚ùå –ü—Ä–æ–±–ª–µ–º–∞: None –≤ —Å–ø–∏—Å–∫–µ
```

**–°—Ç–∞–ª–æ:**
```python
def _landmarks_to_list(self, pose_landmarks) -> List[Dict[str, float]]:
    if pose_landmarks is None:
        # ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–∑ 33 –Ω—É–ª–µ–≤—ã—Ö —Ç–æ—á–µ–∫ –≤–º–µ—Å—Ç–æ None
        return [
            {"x": 0.0, "y": 0.0, "z": 0.0, "visibility": 0.0}
            for _ in range(33)
        ]
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö, –Ω–µ—Ç —Å–º–µ—à–∞–Ω–Ω—ã—Ö —Ç–∏–ø–æ–≤ (None –∏ —Å–ø–∏—Å–∫–∏).

---

### –ü–†–û–ë–õ–ï–ú–ê 2: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ mini_rgbd_joints ‚úÖ –£–ñ–ï –ë–´–õ–û –†–ï–ê–õ–ò–ó–û–í–ê–ù–û

–ú–µ—Ç–æ–¥ `_convert_to_mini_rgbd` —É–∂–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç 33 —Ç–æ—á–∫–∏ MediaPipe –≤ 25 —Ç–æ—á–µ–∫ MINI-RGBD.

**–î–æ–±–∞–≤–ª–µ–Ω–æ:** –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ JSON:
- `has_person`: –§–ª–∞–≥ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è —á–µ–ª–æ–≤–µ–∫–∞
- `confidence`: –°—Ä–µ–¥–Ω—è—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –ø–æ –≤—Å–µ–º —Ç–æ—á–∫–∞–º

---

### –ü–†–û–ë–õ–ï–ú–ê 3: –ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∫–ª—é—á–µ–≤—ã—Ö —Ç–æ—á–µ–∫ ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

**–ë—ã–ª–æ:**
```python
if landmarks:
    kp = np.array(...)
    keypoints_list.append(kp)
else:
    keypoints_list.append(None)  # ‚ùå –°–º–µ—à–∞–Ω–Ω—ã–µ —Ç–∏–ø—ã
```

**–°—Ç–∞–ª–æ:**
```python
if landmarks and len(landmarks) == 33:
    kp = np.array(...)
else:
    # ‚úÖ –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –º–∞—Å—Å–∏–≤, –¥–∞–∂–µ –µ—Å–ª–∏ landmarks –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã
    kp = np.zeros((33, 4), dtype=np.float32)

keypoints_list.append(kp)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Å–µ–≥–¥–∞ –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç `List[np.ndarray]`, –Ω–µ—Ç None.

---

### –ü–†–û–ë–õ–ï–ú–ê 4: –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–ª—é—á–µ–≤—ã—Ö —Ç–æ—á–µ–∫ ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û

**–ù–æ–≤—ã–π –º–µ—Ç–æ–¥:** `filter_low_confidence_keypoints()`

```python
def filter_low_confidence_keypoints(
    self, keypoints_array: np.ndarray, min_visibility: float = 0.3
) -> np.ndarray:
    """
    –§–∏–ª—å—Ç—Ä—É–µ—Ç —Ç–æ—á–∫–∏ —Å –Ω–∏–∑–∫–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å—é (visibility).
    –¢–æ—á–∫–∏ —Å visibility < min_visibility –∑–∞–º–µ–Ω—è—é—Ç—Å—è –Ω–∞ NaN.
    """
    filtered = keypoints_array.copy()
    visibility = keypoints_array[:, 3]  # 4-–π —Å—Ç–æ–ª–±–µ—Ü - visibility
    
    # –ó–∞–º–µ–Ω—è–µ–º —Ç–æ—á–∫–∏ —Å –Ω–∏–∑–∫–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å—é –Ω–∞ NaN
    low_confidence_mask = visibility < min_visibility
    filtered[low_confidence_mask, :3] = np.nan  # x, y, z —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è NaN
    
    return filtered
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –≤ `process_keypoints()` –ø—Ä–∏ `filter_confidence=True`.

---

### –ü–†–û–ë–õ–ï–ú–ê 5: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û

**–ù–æ–≤—ã–π –º–µ—Ç–æ–¥:** `smooth_keypoints_temporally()`

```python
def smooth_keypoints_temporally(
    self, keypoints_list: List[np.ndarray], window_size: int = 3
) -> List[np.ndarray]:
    """
    –°–≥–ª–∞–∂–∏–≤–∞–µ—Ç –∫–ª—é—á–µ–≤—ã–µ —Ç–æ—á–∫–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å –ø–æ–º–æ—â—å—é —Å–∫–æ–ª—å–∑—è—â–µ–≥–æ —Å—Ä–µ–¥–Ω–µ–≥–æ.
    """
    if len(keypoints_list) < window_size:
        return keypoints_list
    
    smoothed = []
    for i in range(len(keypoints_list)):
        # –û–∫–Ω–æ –¥–ª—è —Å–∫–æ–ª—å–∑—è—â–µ–≥–æ —Å—Ä–µ–¥–Ω–µ–≥–æ
        start = max(0, i - window_size // 2)
        end = min(len(keypoints_list), i + window_size // 2 + 1)
        
        # –°—Ä–µ–¥–Ω–µ–µ –ø–æ –æ–∫–Ω—É (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º NaN)
        window = np.array(keypoints_list[start:end])
        smoothed_frame = np.nanmean(window, axis=0)
        
        # –ó–∞–º–µ–Ω—è–µ–º NaN –Ω–∞ 0
        smoothed_frame = np.nan_to_num(smoothed_frame, nan=0.0)
        smoothed.append(smoothed_frame.astype(np.float32))
    
    return smoothed
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –≤ `process_keypoints()` –ø—Ä–∏ `smooth_temporal=True`.

---

## üîÑ –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω –æ–±—Ä–∞–±–æ—Ç–∫–∏

### –ù–æ–≤—ã–π –º–µ—Ç–æ–¥ `process_keypoints()`:

```python
def process_keypoints(
    self, keypoints_list: List[Optional[np.ndarray]], 
    filter_confidence: bool = True,      # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ visibility
    smooth_temporal: bool = True,         # –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ
    min_visibility: float = 0.3,         # –ü–æ—Ä–æ–≥ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
    smoothing_window: int = 3,            # –†–∞–∑–º–µ—Ä –æ–∫–Ω–∞ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è
) -> List[np.ndarray]:
```

**–≠—Ç–∞–ø—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏:**

1. **–ó–∞–º–µ–Ω–∞ None –Ω–∞ –Ω—É–ª–µ–≤—ã–µ –º–∞—Å—Å–∏–≤—ã** ‚Üí –ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
2. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ confidence** (–µ—Å–ª–∏ `filter_confidence=True`) ‚Üí –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–Ω–∞–¥–µ–∂–Ω—ã—Ö —Ç–æ—á–µ–∫
3. **–í—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ** (–µ—Å–ª–∏ `smooth_temporal=True`) ‚Üí –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –¥—Ä–æ–∂–∞–Ω–∏—è
4. **–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ MINI-RGBD** ‚Üí 33 —Ç–æ—á–∫–∏ ‚Üí 25 —Ç–æ—á–µ–∫
5. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –ø–æ–∑** ‚Üí –ú–∏–Ω–∏–º—É–º 15 –≤–∞–ª–∏–¥–Ω—ã—Ö —Å—É—Å—Ç–∞–≤–æ–≤
6. **–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è** ‚Üí –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ç–æ—Ä—Å–∞ –∏–ª–∏ bounding box
7. **–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π** ‚Üí –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ 30 –∫–∞–¥—Ä–æ–≤

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —É–ª—É—á—à–µ–Ω–∏–π

### –î–æ:
- ‚ùå –°–º–µ—à–∞–Ω–Ω—ã–µ —Ç–∏–ø—ã (None –∏ np.array)
- ‚ùå –ù–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ confidence
- ‚ùå –î—Ä–æ–∂–∞–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Ç–æ—á–µ–∫ –º–µ–∂–¥—É –∫–∞–¥—Ä–∞–º–∏
- ‚ùå –ü—Ä–æ–±–ª–µ–º—ã —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π None-landmarks

### –ü–æ—Å–ª–µ:
- ‚úÖ –ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–µ–Ω–∞–¥–µ–∂–Ω—ã—Ö —Ç–æ—á–µ–∫
- ‚úÖ –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö landmarks
- ‚úÖ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ JSON (confidence, has_person)

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

### –î–ª—è –æ–±—ã—á–Ω—ã—Ö –≤–∏–¥–µ–æ:
```python
sequences = pose_processor.process_keypoints(
    keypoints_list,
    filter_confidence=True,    # –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è
    smooth_temporal=True,      # –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è
    min_visibility=0.3,        # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–æ—Ä–æ–≥
    smoothing_window=3,        # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ–∫–Ω–æ
)
```

### –î–ª—è –≤–∏–¥–µ–æ —Å –Ω–∏–∑–∫–∏–º –∫–∞—á–µ—Å—Ç–≤–æ–º:
```python
sequences = pose_processor.process_keypoints(
    keypoints_list,
    filter_confidence=True,
    smooth_temporal=True,
    min_visibility=0.5,        # –ë–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–π –ø–æ—Ä–æ–≥
    smoothing_window=5,        # –ë–æ–ª—å—à–µ–µ –æ–∫–Ω–æ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è
)
```

### –î–ª—è –≤—ã—Å–æ–∫–æ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –≤–∏–¥–µ–æ (–±—ã—Å—Ç—Ä–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞):
```python
sequences = pose_processor.process_keypoints(
    keypoints_list,
    filter_confidence=False,   # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é
    smooth_temporal=False,     # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ
)
```

---

## üìù –§–∞–π–ª—ã —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏

1. **`video_processor.py`**:
   - ‚úÖ `_landmarks_to_list()` - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤–º–µ—Å—Ç–æ None
   - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è `has_person` –∏ `confidence` –≤ JSON

2. **`inference_advanced.py`**:
   - ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ keypoints –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ (–Ω–µ None)

3. **`utils/pose_processor.py`**:
   - ‚úÖ `filter_low_confidence_keypoints()` - –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥
   - ‚úÖ `smooth_keypoints_temporally()` - –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥
   - ‚úÖ `process_keypoints()` - —É–ª—É—á—à–µ–Ω —Å –Ω–æ–≤—ã–º–∏ –æ–ø—Ü–∏—è–º–∏

4. **`utils/video_visualizer.py`**:
   - ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ keypoints (—Ç–µ–ø–µ—Ä—å –≤—Å–µ–≥–¥–∞ –º–∞—Å—Å–∏–≤)

---

## ‚úÖ –ò—Ç–æ–≥

–í—Å–µ 5 –ø—Ä–æ–±–ª–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:
1. ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ None-landmarks
2. ‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è 33 ‚Üí 25 —Ç–æ—á–µ–∫ (—É–∂–µ –±—ã–ª–æ)
3. ‚úÖ –ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö
4. ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ confidence
5. ‚úÖ –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–∞ –∏ —É—Å—Ç–æ–π—á–∏–≤–∞ –∫ —Ä–∞–∑–ª–∏—á–Ω—ã–º —É—Å–ª–æ–≤–∏—è–º —Å—ä–µ–º–∫–∏!

